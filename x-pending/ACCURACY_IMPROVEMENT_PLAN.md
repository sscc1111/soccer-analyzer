# 解析精度向上計画

サッカー解析パイプライン全体の精度向上のための包括的な実装計画です。

---

## 1. 位置情報の正確な取得（3つのオプション全て実装）

現状の問題: 全てのイベントの位置が `{x: 0, y: 0}` のダミー値として保存されている。

### Option 1: ゾーン→座標変換（即時対応）

- [ ] **1.1** `lib/zoneToCoordinate.ts` ユーティリティを作成
  - [ ] ゾーン定義（defensive_third, middle_third, attacking_third）を座標範囲にマッピング
  - [ ] ゾーン中心座標を返す関数 `getZoneCenterCoordinate(zone: Zone): Point2D`
  - [ ] ゾーン内のランダム座標を返す関数 `getRandomPositionInZone(zone: Zone): Point2D`
  - [ ] 単体テスト作成

- [ ] **1.2** `RawEvent` インターフェースに `estimatedPosition` フィールドを追加
  - [ ] `lib/deduplication.ts` の `RawEvent` 型を拡張
  - [ ] `DeduplicatedEvent` 型にも反映

- [ ] **1.3** `07c_deduplicateEvents.ts` でゾーン→座標変換を適用
  - [ ] PassEventDoc の position フィールドを変換後の座標に設定
  - [ ] CarryEventDoc の startPosition/endPosition を変換後の座標に設定
  - [ ] TurnoverEventDoc の position フィールドを変換後の座標に設定
  - [ ] 位置情報のソース（zone_conversion）をメタデータに記録

### Option 2: Geminiプロンプトで位置出力を追加

- [ ] **2.1** `event_detection_v3.json` プロンプトを更新（→v4）
  - [ ] イベント出力スキーマに `position: {x: number, y: number}` を追加
  - [ ] 位置推定のインストラクションを追加（ピッチを0-100座標系で表現）
  - [ ] 位置精度向上のためのビジュアルキュー説明を追加

- [ ] **2.2** `RawEvent` インターフェースに `position` フィールドを追加
  - [ ] `lib/deduplication.ts` を更新
  - [ ] 型定義: `position?: { x: number; y: number; confidence?: number }`

- [ ] **2.3** `07b_detectEventsWindowed.ts` でGemini出力からpositionを取得
  - [ ] レスポンスパース処理を更新
  - [ ] positionが欠落した場合のフォールバック処理（Option 1のゾーン変換を使用）

- [ ] **2.4** `lib/deduplication.ts` で位置情報のマージロジックを追加
  - [ ] `mergeCluster` 関数で複数イベントの位置を加重平均
  - [ ] 信頼度ベースの位置マージアルゴリズム実装

- [ ] **2.5** `07c_deduplicateEvents.ts` でマージ後の位置を使用
  - [ ] Gemini出力の位置を優先
  - [ ] 欠落時はゾーン変換にフォールバック

### Option 3: ボール検出との統合

- [ ] **3.1** ボール検出パイプラインの調査
  - [ ] 既存のボール検出実装を確認
  - [ ] ボール位置データのFirestore保存形式を確認
  - [ ] イベントタイムスタンプとボール位置のマッチング方法を設計

- [ ] **3.2** `lib/ballPositionMatcher.ts` ユーティリティを作成
  - [ ] イベントタイムスタンプから最も近いボール位置を取得する関数
  - [ ] 時間補間によるボール位置推定（前後のフレームから）
  - [ ] 信頼度スコアの計算（時間差に基づく）

- [ ] **3.3** イベント保存時にボール位置を統合
  - [ ] `07c_deduplicateEvents.ts` でボール位置を取得
  - [ ] 位置情報の優先順位: ボール検出 > Gemini出力 > ゾーン変換
  - [ ] 位置情報のソースをメタデータに記録

- [ ] **3.4** 位置情報の検証ロジック追加
  - [ ] イベントタイプと位置の整合性チェック（例: ゴールは相手ゴール付近）
  - [ ] 連続イベント間の位置移動が妥当かチェック
  - [ ] 異常値の警告ログ出力

---

## 2. パス・キャリー検出の精度向上

### 2.1 パス検出の改善

- [ ] **2.1.1** プロンプト改善（event_detection → v4）
  - [ ] パス開始・終了の視覚的キューを詳細化
  - [ ] パス成功/失敗の判定基準を明確化
  - [ ] ショートパス vs ロングパスの区別基準を追加

- [ ] **2.1.2** パス連鎖の検出
  - [ ] 連続するパスイベントの時間的整合性チェック
  - [ ] 同一チーム内でのパス連鎖を検証
  - [ ] 不自然に短い間隔のパスを警告

- [ ] **2.1.3** パス方向の検出追加
  - [ ] `PassEventDoc` に `direction` フィールド追加（forward/backward/lateral）
  - [ ] プロンプトでパス方向の出力を要求

### 2.2 キャリー検出の改善

- [ ] **2.2.1** キャリー継続時間の精度向上
  - [ ] 開始・終了タイムスタンプの精度向上
  - [ ] プロンプトでキャリー終了条件を明確化（パス、シュート、ロスト等）

- [ ] **2.2.2** ドリブル vs 単純なキャリーの区別
  - [ ] `CarryEventDoc` に `isDribble` フラグ追加
  - [ ] 敵との対面状況をプロンプトで検出

- [ ] **2.2.3** キャリー距離の計算改善
  - [ ] 位置情報を使用した実距離計算
  - [ ] ゾーン移動による距離推定

---

## 3. ターンオーバー・セットピース検出の精度向上

### 3.1 ターンオーバー検出の改善

- [ ] **3.1.1** ターンオーバータイプの詳細化
  - [ ] tackle, interception, bad_touch, out_of_bounds の判定精度向上
  - [ ] プロンプトで各タイプの視覚的特徴を詳細化

- [ ] **3.1.2** ターンオーバー直前のイベントとの連携
  - [ ] パス失敗 → ターンオーバーの連鎖を検証
  - [ ] キャリーロスト → ターンオーバーの連鎖を検証

- [ ] **3.1.3** ボール支配権移動の検証
  - [ ] ターンオーバー前後でチームが変わることを検証
  - [ ] 矛盾するイベントシーケンスを警告

### 3.2 セットピース検出の改善

- [ ] **3.2.1** セットピースタイプの精度向上
  - [ ] corner, free_kick, penalty, throw_in, goal_kick の区別
  - [ ] 視覚的キュー（選手の配置、ボール位置）を詳細化

- [ ] **3.2.2** セットピース後の展開検出
  - [ ] セットピース → シュート/クリアの連鎖
  - [ ] セットピースからの得点機会の追跡

---

## 4. シュート・ゴール検出の精度向上

### 4.1 シュート検出の改善

- [ ] **4.1.1** シュート結果の精度向上
  - [ ] goal, saved, blocked, missed, post の区別
  - [ ] ゴールキーパーの動きを検出キューに追加

- [ ] **4.1.2** シュート位置の検出
  - [ ] ペナルティエリア内外の区別
  - [ ] シュート角度・距離の推定

- [ ] **4.1.3** ゴール検出の特別処理（Phase 2.8で実装済み）
  - [ ] ゴール検出の信頼度閾値を確認（0.3以上で保持）
  - [ ] ゴールイベントの重複排除ロジックを確認

### 4.2 期待得点(xG)の改善

- [ ] **4.2.1** シュート位置に基づくxG計算
  - [ ] 位置情報を使用したxG計算の精度向上
  - [ ] シュートタイプ（ヘディング、足）による補正

---

## 5. 選手識別の精度向上

### 5.1 背番号認識の改善

- [ ] **5.1.1** 背番号認識プロンプトの改善
  - [ ] 視認性が低い場合のフォールバック戦略
  - [ ] チームカラーと背番号の組み合わせ検出

- [ ] **5.1.2** 選手追跡との連携
  - [ ] trackId → playerId マッピングの精度向上
  - [ ] 同一選手の複数検出をマージ

### 5.2 選手-イベント紐付けの改善

- [ ] **5.2.1** イベント実行者の特定精度向上
  - [ ] ボール近傍の選手を優先
  - [ ] 動作（キック、ヘディング等）の検出

- [ ] **5.2.2** 選手識別の信頼度スコアリング
  - [ ] 高信頼度の識別結果を優先
  - [ ] 低信頼度の識別は「不明」として記録

---

## 6. 戦術分析の精度向上

### 6.1 フォーメーション検出の改善

- [ ] **6.1.1** 時間経過に伴うフォーメーション変化の検出
  - [ ] ハーフごとのフォーメーション分析
  - [ ] 選手交代後のフォーメーション変化

- [ ] **6.1.2** 攻守でのフォーメーション変化
  - [ ] 攻撃時と守備時のフォーメーション区別
  - [ ] トランジション時の配置分析

### 6.2 戦術パターンの検出

- [ ] **6.2.1** 攻撃パターンの検出精度向上
  - [ ] サイド攻撃 vs 中央突破の区別
  - [ ] カウンター攻撃の検出

- [ ] **6.2.2** 守備パターンの検出精度向上
  - [ ] ハイプレス vs リトリートの区別
  - [ ] マンマーク vs ゾーンの区別

---

## 7. シーン・クリップ抽出の精度向上

### 7.1 重要シーン検出の改善

- [ ] **7.1.1** シーン重要度スコアリングの改善
  - [ ] ゴール/シュートシーンの最優先
  - [ ] 決定機の検出精度向上

- [ ] **7.1.2** シーン境界の精度向上
  - [ ] シーン開始・終了タイミングの調整
  - [ ] コンテキスト（前後の展開）を含める

### 7.2 クリップ-イベント連携

- [ ] **7.2.1** クリップ内のイベント紐付け
  - [ ] タイムスタンプベースのマッチング精度向上
  - [ ] 複数イベントを含むクリップの処理

- [ ] **7.2.2** クリップラベリングの改善
  - [ ] イベントタイプに基づくラベル自動付与
  - [ ] 複合イベント（コンビネーション等）のラベリング

---

## 8. クロスバリデーション・整合性検証

### 8.1 イベント間の整合性検証

- [ ] **8.1.1** 時間的整合性チェック
  - [ ] 連続イベントの時間順序検証
  - [ ] 物理的に不可能な時間間隔の検出

- [ ] **8.1.2** 論理的整合性チェック
  - [ ] チームの連続性検証（パス後に同チームのイベント）
  - [ ] ボール支配権の連続性検証

### 8.2 シーン-クリップ-イベント間の整合性

- [ ] **8.2.1** タイムスタンプアライメント
  - [ ] 3つのデータソース間のタイムスタンプ整合性
  - [ ] 不一致の警告・自動修正

- [ ] **8.2.2** アンサンブル信頼度スコアリング
  - [ ] 複数ソースからの検出で信頼度ブースト
  - [ ] 単一ソースのみの検出は信頼度ダウン

### 8.3 重複検出の精度向上

- [ ] **8.3.1** イベントタイプ別の重複閾値調整（Phase 2.7で実装済み）
  - [ ] 現在の閾値を確認・検証
  - [ ] 必要に応じて閾値を調整

- [ ] **8.3.2** 位置情報を使用した重複判定
  - [ ] 同一位置での同一イベントをより正確にマージ
  - [ ] 異なる位置での類似イベントは別イベントとして保持

---

## 9. 検証・テスト

### 9.1 単体テスト

- [ ] **9.1.1** ゾーン→座標変換のテスト
- [ ] **9.1.2** 位置マージロジックのテスト
- [ ] **9.1.3** 整合性チェックロジックのテスト

### 9.2 統合テスト

- [ ] **9.2.1** 既存の試合データで精度検証
- [ ] **9.2.2** 新しい試合データでの検証
- [ ] **9.2.3** 精度メトリクスの計測・記録

### 9.3 回帰テスト

- [ ] **9.3.1** 既存機能が壊れていないことを確認
- [ ] **9.3.2** パフォーマンス（処理時間）の確認

---

## 実装優先順位（推奨）

1. **位置情報 Option 1（ゾーン変換）** - 即時対応可能、他の改善の基盤
2. **位置情報 Option 2（Geminiプロンプト）** - 精度向上の核心
3. **クロスバリデーション** - 全体的な品質向上
4. **位置情報 Option 3（ボール検出統合）** - 最も精度が高いが依存関係あり
5. **各イベントタイプ別の改善** - 個別対応

---

## 備考

- 各タスクのチェックボックスは完了時にチェックを入れる
- 実装中に発見した追加タスクはこのファイルに追記する
- 問題が発生した場合は該当タスクにメモを追記する
