rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    // P0-SECURITY: Helper function to get user's deviceId from users/{uid}
    function getUserDeviceId() {
      return get(/databases/$(database)/documents/users/$(request.auth.uid)).data.deviceId;
    }

    // P0-SECURITY: Check if user owns the match via ownerUid
    function isOwnerByUid(matchData) {
      return matchData.ownerUid == request.auth.uid;
    }

    // P0-SECURITY: Check if user owns the match via deviceId (verified from users collection)
    function isOwnerByDeviceId(matchData) {
      return matchData.deviceId != null && matchData.deviceId == getUserDeviceId();
    }

    // P0-SECURITY: Combined ownership check
    function isMatchOwner(matchData) {
      return isOwnerByUid(matchData) || isOwnerByDeviceId(matchData);
    }

    match /matches/{matchId} {
      // P0-SECURITY: Read - ownerUid matches OR deviceId matches user's registered deviceId
      allow read: if request.auth != null && isMatchOwner(resource.data);

      // P0-SECURITY: Create - ownerUid must be current user OR deviceId must match
      allow create: if request.auth != null && (
        request.resource.data.ownerUid == request.auth.uid ||
        (request.resource.data.deviceId != null && request.resource.data.deviceId == getUserDeviceId())
      );

      // P0-SECURITY: Update/Delete - must own the match
      allow update, delete: if request.auth != null && isMatchOwner(resource.data);
    }

    match /matches/{matchId}/{sub=**} {
      // P0-SECURITY: Subcollections - must own parent match
      allow read, write: if request.auth != null &&
        isMatchOwner(get(/databases/$(database)/documents/matches/$(matchId)).data);
    }

    match /jobs/{jobId} {
      // Jobs are system-managed
      // Users can read jobs (to check status), but only Cloud Functions can write
      allow read: if request.auth != null;
      allow write: if false; // Only admin SDK (Cloud Functions) can write
    }

    // Future: user settings collection
    match /users/{userId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
    match /users/{userId}/{sub=**} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }
  }
}
